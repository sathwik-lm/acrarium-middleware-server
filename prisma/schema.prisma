generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  VIEWER
}

enum CrashSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum IssueStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  IGNORED
  REOPENED
}

enum IssuePriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ActivityType {
  USER_LOGIN
  USER_CREATED
  USER_UPDATED
  ISSUE_CREATED
  ISSUE_UPDATED
  ISSUE_RESOLVED
  COMMENT_ADDED
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String?
  role         UserRole @default(VIEWER)

  lastLoginAt DateTime?
  lastLoginIP String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assignedIssues Issue[]        @relation("AssignedIssues")
  comments       Comment[]
  activityLogs   ActivityLog[]
  refreshTokens  RefreshToken[]
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model BlacklistedToken {
  id        String   @id @default(cuid())
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
}



model Crash {
  id String @id @default(cuid())

  eventId      String @unique
  eventType    String @default("Crash")
  message      String @db.Text
  stackTrace   String @db.Text
  stackTraceId BigInt

  appVersion      String
  sdkVersion      String?
  firmwareVersion String?

  deviceModel String
  deviceId    String

  cpuTemperature   Float?
  gpuTemperature   Float?
  boardTemperature Float?

  timestampUTC DateTime
  uploadedAt   DateTime

  clientId String

  severity    CrashSeverity @default(MEDIUM)
  fingerprint String

  issueId String?
  issue   Issue?  @relation(fields: [issueId], references: [id], onDelete: SetNull)

  aiAnalysis AIAnalysis?

  createdAt DateTime @default(now())


  @@index([issueId])
  @@index([fingerprint])
  @@index([timestampUTC])
  @@index([deviceId])
}

model Issue {
  id          String @id @default(cuid())
  title       String
  fingerprint String @unique

  status   IssueStatus   @default(OPEN)
  priority IssuePriority @default(MEDIUM)

  firstSeen       DateTime
  lastSeen        DateTime
  occurrenceCount Int      @default(1)

  sampleMessage    String @db.Text
  sampleStackTrace String @db.Text

  assignedToId String?
  assignedTo   User?   @relation("AssignedIssues", fields: [assignedToId], references: [id], onDelete: SetNull)

  tags String[] @default([])


  crashes      Crash[]
  comments     Comment[]
  aiSuggestion AISuggestion?

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  resolvedAt DateTime?

  @@index([status])
  @@index([priority])
  @@index([assignedToId])
}

model Comment {
  id      String @id @default(cuid())
  content String @db.Text

  issueId String
  issue   Issue  @relation(fields: [issueId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AIAnalysis {
  id String @id @default(cuid())

  crashId String @unique
  crash   Crash  @relation(fields: [crashId], references: [id], onDelete: Cascade)

  rootCause    String  @db.Text
  explanation  String  @db.Text
  affectedCode String? @db.Text
  confidence   Float

  modelUsed      String
  processingTime Int

  createdAt DateTime @default(now())
}

model AISuggestion {
  id String @id @default(cuid())

  issueId String @unique
  issue   Issue  @relation(fields: [issueId], references: [id], onDelete: Cascade)

  suggestedFix  String   @db.Text
  codeSnippet   String?  @db.Text
  reasoning     String   @db.Text
  similarIssues String[] @default([])

  helpfulCount    Int @default(0)
  notHelpfulCount Int @default(0)

  modelUsed  String
  confidence Float

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CrashPattern {
  id String @id @default(cuid())

  patternType String
  patternKey  String
  description String @db.Text

  occurrences     Int
  affectedDevices Int
  crashRate       Float

  conditions Json

  firstDetected DateTime
  lastDetected  DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([patternKey])
  @@index([patternType])
}

enum AlertType {
  NEW_CRASH
  CRASH_SPIKE
  CRITICAL_CRASH
  ISSUE_ASSIGNED
  PATTERN_DETECTED
}

enum AlertChannel {
  EMAIL
  SLACK
  WEBHOOK
}

model Alert {
  id      String       @id @default(cuid())
  type    AlertType
  channel AlertChannel

  title    String
  message  String @db.Text
  metadata Json?

  sent   Boolean   @default(false)
  sentAt DateTime?
  error  String?   @db.Text

  createdAt DateTime @default(now())

  @@index([sent])
  @@index([createdAt])
}

model ActivityLog {
  id          String       @id @default(cuid())
  type        ActivityType
  description String
  metadata    Json?
  ipAddress   String?

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}
